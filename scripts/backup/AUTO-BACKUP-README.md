# ìë™ ë°±ì—… ì‹œìŠ¤í…œ

## ê°œìš”

BACKUP.mdì— ëª…ì‹œëœ 3-2-1 ë°±ì—… ì „ëµì„ ê¸°ë°˜ìœ¼ë¡œ í•œ ìë™ ë°±ì—… ì‹œìŠ¤í…œì…ë‹ˆë‹¤.
ë°±ì—”ë“œ ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¼ ë•Œ **í•œêµ­ ì‹œê°„(KST) ê¸°ì¤€**ìœ¼ë¡œ ìë™ ë°±ì—…ì´ ìˆ˜í–‰ë©ë‹ˆë‹¤.

**âš ï¸ Vercel í™˜ê²½ì—ì„œëŠ” ìë™ìœ¼ë¡œ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.** (ì„œë²„ë¦¬ìŠ¤ í™˜ê²½ ì œì•½)

## ë°±ì—… ì „ëµ

### ğŸ“… ë°±ì—… ì£¼ê¸° (í•œêµ­ ì‹œê°„ ê¸°ì¤€)

| ì£¼ê¸° | ìŠ¤ì¼€ì¤„ (KST) | ë³´ê´€ ê¸°ê°„ | ë³´ê´€ ê°œìˆ˜ | ë””ë ‰í† ë¦¬ |
|------|--------------|-----------|-----------|----------|
| **4ì‹œê°„** | 04:00, 08:00, 12:00, 16:00, 20:00 | 24ì‹œê°„ | 6ê°œ | `/backup/hourly/` |
| **ì¼ì¼** | ë§¤ì¼ 00:00 (hourly + daily í´ë”ì— ë™ì‹œ ì €ì¥) | 30ì¼ | 30ê°œ | `/backup/daily/` |
| **ì£¼ê°„** | ë§¤ì£¼ ì¼ìš”ì¼ 00:00 | 12ì£¼(3ê°œì›”) | 12ê°œ | `/backup/weekly/` |
| **ì›”ê°„** | ë§¤ì›” 1ì¼ 00:00 | 12ê°œì›” | 12ê°œ | `/backup/monthly/` |
| **ì—°ê°„** | ë¶„ê¸°ë§/ì—°ë§ (3,6,9,12ì›” 1ì¼ 00:00) | 3-7ë…„ | ìˆ˜ë™ ê´€ë¦¬ | `/backup/yearly/` |

### ğŸ¯ 3-2-1 ë°±ì—… ì›ì¹™

- **3ê°œ ë³µì‚¬ë³¸**: ì›ë³¸ DB + ë°±ì—… 2ê°œ ì´ìƒ
- **2ê°œ ë‹¤ë¥¸ ë§¤ì²´**: ë¡œì»¬ ë””ìŠ¤í¬ + í´ë¼ìš°ë“œ ìŠ¤í† ë¦¬ì§€ (S3 ì—°ë™ ì‹œ)
- **1ê°œ ì›ê²©ì§€**: AWS S3 (ë‹¤ë¥¸ ë¦¬ì „ ê¶Œì¥, ë¯¸ì •)

## ë””ë ‰í† ë¦¬ êµ¬ì¡°

```
/backup/
â”œâ”€â”€ hourly/          # 4ì‹œê°„ë§ˆë‹¤, 6ê°œ íŒŒì¼ (ìµœê·¼ 24ì‹œê°„)
â”œâ”€â”€ daily/           # ë§¤ì¼ ìì •, 30ê°œ íŒŒì¼ (30ì¼)
â”œâ”€â”€ weekly/          # ë§¤ì£¼ ì¼ìš”ì¼, 12ê°œ íŒŒì¼ (3ê°œì›”)
â”œâ”€â”€ monthly/         # ë§¤ì›” 1ì¼, 12ê°œ íŒŒì¼ (1ë…„)
â””â”€â”€ yearly/          # ë¶„ê¸°ë§/ì—°ë§, ìˆ˜ë™ ê´€ë¦¬ (3-7ë…„)
```

## ìë™ ì‹¤í–‰

### ì„œë²„ ì‹œì‘ ì‹œ ìë™ í™œì„±í™”

ë°±ì—”ë“œ ì„œë²„ê°€ ì‹œì‘ë˜ë©´ `BackupSchedulerService`ê°€ ìë™ìœ¼ë¡œ ì´ˆê¸°í™”ë˜ê³  í¬ë¡  ì‘ì—…ì´ í™œì„±í™”ë©ë‹ˆë‹¤.

**âš ï¸ Vercel í™˜ê²½ì—ì„œëŠ” ìë™ìœ¼ë¡œ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.**

#### EC2 í™˜ê²½

```bash
# ì„œë²„ ì‹œì‘
npm run start:dev

# ë¡œê·¸ í™•ì¸
[Nest] 12345  - ë°±ì—… ë””ë ‰í† ë¦¬ ìƒì„±: /path/to/backup/hourly
[Nest] 12345  - ë°±ì—… ë””ë ‰í† ë¦¬ ìƒì„±: /path/to/backup/daily
...
[Nest] 12345  - ğŸ• 4ì‹œê°„ ë‹¨ìœ„ ë°±ì—… ì‹œì‘... (KST)
```

#### Vercel í™˜ê²½

```bash
# Vercel í™˜ê²½ì—ì„œ ì‹œì‘í•˜ë©´
[Nest] 12345  - âš ï¸  Vercel í™˜ê²½ ê°ì§€: ë°±ì—… ìŠ¤ì¼€ì¤„ëŸ¬ê°€ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.
```

Vercelì€ ì„œë²„ë¦¬ìŠ¤ í™˜ê²½ìœ¼ë¡œ:
- íŒŒì¼ ì‹œìŠ¤í…œ ì“°ê¸° ì œí•œ (`/tmp` ì™¸ ì“°ê¸° ë¶ˆê°€)
- ì¥ì‹œê°„ ì‹¤í–‰ í¬ë¡  ì‘ì—… ë¶€ì í•©
- ë°±ì—… ê¸°ëŠ¥ì€ EC2 í™˜ê²½ì—ì„œë§Œ ì‚¬ìš© ê°€ëŠ¥

### í¬ë¡  ìŠ¤ì¼€ì¤„ (í•œêµ­ ì‹œê°„ ê¸°ì¤€)

| ì‹œê°„ (KST) | ì‹¤í–‰ë˜ëŠ” ë°±ì—… |
|------------|---------------|
| **00:00** | hourly + daily + (ì¼ìš”ì¼ì´ë©´ weekly) + (1ì¼ì´ë©´ monthly + ë¶„ê¸°ë§ì´ë©´ yearly) |
| **04:00** | hourly |
| **08:00** | hourly |
| **12:00** | hourly |
| **16:00** | hourly |
| **20:00** | hourly |

## â° ì‹œê°„ëŒ€ ì„¤ì •

- **íƒ€ì„ì¡´**: `Asia/Seoul` (í•œêµ­ í‘œì¤€ì‹œ, KST)
- **UTC ì˜¤í”„ì…‹**: +09:00
- **ì„œë²„ ì‹œê°„ê³¼ ë¬´ê´€**: ì„œë²„ê°€ UTCë‚˜ ë‹¤ë¥¸ ì‹œê°„ëŒ€ë¡œ ì„¤ì •ë˜ì–´ ìˆì–´ë„ í•œêµ­ ì‹œê°„ ê¸°ì¤€ìœ¼ë¡œ ë™ì‘

```typescript
@Cron('0 0,4,8,12,16,20 * * *', {
  timeZone: 'Asia/Seoul',  // í•œêµ­ ì‹œê°„ ê¸°ì¤€
})
```

## í™˜ê²½ ê°ì§€

ë°±ì—… ìŠ¤ì¼€ì¤„ëŸ¬ëŠ” `process.env.VERCEL` í™˜ê²½ ë³€ìˆ˜ë¥¼ í™•ì¸í•˜ì—¬ ìë™ìœ¼ë¡œ í™˜ê²½ì„ ê°ì§€í•©ë‹ˆë‹¤.

```typescript
// Vercel í™˜ê²½ ê°ì§€
if (process.env.VERCEL) {
  // ë°±ì—… ìŠ¤ì¼€ì¤„ëŸ¬ ë¹„í™œì„±í™”
}
```

## API ì—”ë“œí¬ì¸íŠ¸

### 1. ë°±ì—… ìƒíƒœ ì¡°íšŒ

```http
GET /admin/backups/status
Authorization: Bearer {JWT_TOKEN}
```

**ì‘ë‹µ ì˜ˆì‹œ (EC2):**

```json
{
  "hourly": 6,
  "daily": 30,
  "weekly": 12,
  "monthly": 12,
  "yearly": 8
}
```

**ì‘ë‹µ ì˜ˆì‹œ (Vercel):**

```json
{
  "hourly": 0,
  "daily": 0,
  "weekly": 0,
  "monthly": 0,
  "yearly": 0
}
```

### 2. ìˆ˜ë™ ë°±ì—… ì‹¤í–‰

```http
POST /admin/backups/manual?type=daily
Authorization: Bearer {JWT_TOKEN}
```

**Query Parameters:**
- `type`: ë°±ì—… íƒ€ì… (hourly, daily, weekly, monthly)
- ê¸°ë³¸ê°’: `daily`

**ì‘ë‹µ ì˜ˆì‹œ (EC2):**

```json
{
  "message": "daily ë°±ì—…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."
}
```

**ì‘ë‹µ ì˜ˆì‹œ (Vercel):**

```json
{
  "statusCode": 500,
  "message": "Vercel í™˜ê²½ì—ì„œëŠ” ë°±ì—… ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. EC2 í™˜ê²½ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”."
}
```

**ê¶Œí•œ:** `admin` ì—­í•  í•„ìš”

## ë°±ì—… íŒŒì¼ ëª…ëª… ê·œì¹™

```
backup-{type}-{timestamp}-KST.sql
```

**ì˜ˆì‹œ:**
```
backup-hourly-2025-12-15-04-00-00-KST.sql   # KST 04:00
backup-daily-2025-12-15-00-00-00-KST.sql    # KST 00:00
backup-weekly-2025-12-15-00-00-00-KST.sql   # ì¼ìš”ì¼ KST 00:00
backup-monthly-2025-12-01-00-00-00-KST.sql  # 1ì¼ KST 00:00
backup-yearly-2025-12-01-00-00-00-KST.sql   # ì—°ë§ KST 00:00
```

## ë³µêµ¬ ë°©ë²•

### 1. ìˆ˜ë™ ë³µêµ¬ (ìµœì‹  ë°±ì—…)

```bash
npm run db:restore
```

### 2. íŠ¹ì • ë°±ì—… íŒŒì¼ë¡œ ë³µêµ¬

```bash
npm run db:restore backup/daily/backup-daily-2025-12-15-00-00-00.sql
```

### 3. ë³µêµ¬ ìŠ¤í¬ë¦½íŠ¸ ì§ì ‘ ì‹¤í–‰

```bash
npx ts-node scripts/backup/restore-pure.ts backup/weekly/backup-weekly-2025-12-08-00-00-00.sql
```

## ì£¼ì˜ì‚¬í•­

### âš ï¸ ë””ìŠ¤í¬ ìš©ëŸ‰ ê´€ë¦¬

- **hourly**: 6ê°œ Ã— íŒŒì¼í¬ê¸° (ìë™ ì‚­ì œ)
- **daily**: 30ê°œ Ã— íŒŒì¼í¬ê¸° (ìë™ ì‚­ì œ)
- **weekly**: 12ê°œ Ã— íŒŒì¼í¬ê¸° (ìë™ ì‚­ì œ)
- **monthly**: 12ê°œ Ã— íŒŒì¼í¬ê¸° (ìë™ ì‚­ì œ)
- **yearly**: ìˆ˜ë™ ê´€ë¦¬ í•„ìš”

**ì˜ˆìƒ ìš©ëŸ‰** (DB í¬ê¸°ê°€ 100MBì¸ ê²½ìš°):
```
hourly:  6ê°œ Ã— 100MB = 600MB
daily:   30ê°œ Ã— 100MB = 3GB
weekly:  12ê°œ Ã— 100MB = 1.2GB
monthly: 12ê°œ Ã— 100MB = 1.2GB
yearly:  ê°€ë³€ (ìˆ˜ë™ ê´€ë¦¬)
---
í•©ê³„: ì•½ 6GB
```

### ğŸ”’ ë³´ì•ˆ

- ë°±ì—… íŒŒì¼ì€ ë¯¼ê°í•œ ë°ì´í„°ë¥¼ í¬í•¨í•©ë‹ˆë‹¤
- `/backup/` ë””ë ‰í† ë¦¬ëŠ” `.gitignore`ì— í¬í•¨ë¨
- í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œëŠ” íŒŒì¼ ê¶Œí•œ ì„¤ì • í•„ìš”:
  ```bash
  chmod 600 /backup/*/*.sql
  ```

### ğŸ“Š ëª¨ë‹ˆí„°ë§

ë°±ì—… ì‹¤íŒ¨ ì‹œ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”:

```bash
# ë¡œê·¸ í™•ì¸
tail -f logs/app.log | grep -i backup

# ë°±ì—… íŒŒì¼ í™•ì¸
ls -lh backup/hourly/
ls -lh backup/daily/
```

### â° ì‹œê°„ëŒ€ ê´€ë ¨ ì£¼ì˜ì‚¬í•­

1. **ì„œë²„ ì‹œê°„ê³¼ ë¬´ê´€**: ì„œë²„ê°€ UTCë‚˜ ë‹¤ë¥¸ ì‹œê°„ëŒ€ë¡œ ì„¤ì •ë˜ì–´ ìˆì–´ë„ í•œêµ­ ì‹œê°„ ê¸°ì¤€ìœ¼ë¡œ ë°±ì—… ì‹¤í–‰
2. **ì¼ê´‘ ì ˆì•½ ì‹œê°„(DST)**: í•œêµ­ì€ DSTë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ ì—°ì¤‘ ì¼ì •í•œ ì‹œê°„ì— ë°±ì—… ì‹¤í–‰
3. **ë¡œê·¸ ì‹œê°„**: ë¡œê·¸ì— í‘œì‹œë˜ëŠ” ì‹œê°„ì€ ì„œë²„ì˜ ì‹œìŠ¤í…œ ì‹œê°„ì¼ ìˆ˜ ìˆìœ¼ë‚˜, ë°±ì—…ì€ KST ê¸°ì¤€ìœ¼ë¡œ ì‹¤í–‰ë¨

### ğŸš« Vercel í™˜ê²½ ì œì•½

Vercelì€ ì„œë²„ë¦¬ìŠ¤ í”Œë«í¼ìœ¼ë¡œ ë‹¤ìŒ ì œì•½ì´ ìˆìŠµë‹ˆë‹¤:

1. **íŒŒì¼ ì‹œìŠ¤í…œ ì œí•œ**: `/tmp` ì™¸ì˜ ë””ë ‰í† ë¦¬ì— ì“°ê¸° ë¶ˆê°€
2. **ì‹¤í–‰ ì‹œê°„ ì œí•œ**: í•¨ìˆ˜ ì‹¤í–‰ ì‹œê°„ ì œí•œ (10ì´ˆ~5ë¶„)
3. **í¬ë¡  ì‘ì—… ë¶€ì í•©**: ì¥ì‹œê°„ ì‹¤í–‰ í¬ë¡  ì‘ì—… ì§€ì› ì•ˆ ë¨
4. **ìŠ¤í† ë¦¬ì§€ ë¶€ì¬**: ìš”ì²­ ê°„ íŒŒì¼ ê³µìœ  ë¶ˆê°€

**í•´ê²° ë°©ë²•**: AWS EC2 ë˜ëŠ” ë‹¤ë¥¸ ì „í†µì ì¸ ì„œë²„ í™˜ê²½ ì‚¬ìš©

## ë°±ì—… ì‹¤í–‰ ì˜ˆì‹œ (KST ê¸°ì¤€)

```
2025-12-15 (ì›”ìš”ì¼)
00:00 - hourly + daily ë°±ì—… ì‹¤í–‰
04:00 - hourly ë°±ì—… ì‹¤í–‰
08:00 - hourly ë°±ì—… ì‹¤í–‰
12:00 - hourly ë°±ì—… ì‹¤í–‰
16:00 - hourly ë°±ì—… ì‹¤í–‰
20:00 - hourly ë°±ì—… ì‹¤í–‰

2025-12-21 (ì¼ìš”ì¼)
00:00 - hourly + daily + weekly ë°±ì—… ì‹¤í–‰
04:00 - hourly ë°±ì—… ì‹¤í–‰
...

2026-01-01 (ëª©ìš”ì¼)
00:00 - hourly + daily + monthly + yearly ë°±ì—… ì‹¤í–‰ (ì—°ë§)
```

## AWS S3 ì—°ë™ (ì„ íƒì‚¬í•­, ë¯¸ì •)

### ê³„íšëœ ê¸°ëŠ¥

```bash
# S3 ë™ê¸°í™” (ìë™í™” ì˜ˆì •)
aws s3 sync /backup/hourly/ s3://backup-bucket/hourly/
aws s3 sync /backup/daily/ s3://backup-bucket/daily/
aws s3 sync /backup/weekly/ s3://backup-bucket/weekly/
aws s3 sync /backup/monthly/ s3://backup-bucket/monthly/
aws s3 sync /backup/yearly/ s3://backup-bucket/yearly/
```

### S3 ìˆ˜ëª… ì£¼ê¸° ì •ì±… (ê³„íš)

```json
{
  "Rules": [
    {
      "Id": "HourlyBackupLifecycle",
      "Prefix": "hourly/",
      "Status": "Enabled",
      "Expiration": {
        "Days": 1
      }
    },
    {
      "Id": "DailyBackupLifecycle",
      "Prefix": "daily/",
      "Status": "Enabled",
      "Expiration": {
        "Days": 30
      }
    },
    {
      "Id": "YearlyBackupArchive",
      "Prefix": "yearly/",
      "Status": "Enabled",
      "Transitions": [
        {
          "Days": 90,
          "StorageClass": "GLACIER"
        }
      ]
    }
  ]
}
```

## ë¬¸ì œ í•´ê²°

### ë°±ì—…ì´ ì‹¤í–‰ë˜ì§€ ì•ŠìŒ

1. í™˜ê²½ í™•ì¸:
   ```bash
   # Vercel í™˜ê²½ì¸ì§€ í™•ì¸
   echo $VERCEL
   
   # ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸ (EC2)
   ps aux | grep nest
   ```

2. ë¡œê·¸ í™•ì¸:
   ```bash
   tail -f logs/app.log
   ```

3. ë°±ì—… ë””ë ‰í† ë¦¬ ê¶Œí•œ í™•ì¸:
   ```bash
   ls -ld backup/
   ```

### Vercelì—ì„œ ë°±ì—… í•„ìš” ì‹œ

Vercel í™˜ê²½ì—ì„œëŠ” ë‹¤ìŒ ë°©ë²•ì„ ì‚¬ìš©í•˜ì„¸ìš”:

1. **EC2 ë³„ë„ ë°±ì—… ì„œë²„**: ë°±ì—… ì „ìš© EC2 ì¸ìŠ¤í„´ìŠ¤ ìš´ì˜
2. **Supabase ë°±ì—…**: Supabaseì˜ ìë™ ë°±ì—… ê¸°ëŠ¥ í™œìš©
3. **AWS RDS**: RDS ìë™ ë°±ì—… ì‚¬ìš© ì‹œ ê³ ë ¤

### ë””ìŠ¤í¬ ìš©ëŸ‰ ë¶€ì¡±

1. ì˜¤ë˜ëœ ë°±ì—… ìˆ˜ë™ ì‚­ì œ:
   ```bash
   # yearly í´ë”ì˜ ì˜¤ë˜ëœ ë°±ì—… ì‚­ì œ
   find backup/yearly/ -name "*.sql" -mtime +2555 -delete  # 7ë…„ ì´ìƒ
   ```

2. ë°±ì—… ì••ì¶•:
   ```bash
   # ë°±ì—… íŒŒì¼ ì••ì¶• (ì„ íƒì‚¬í•­)
   gzip backup/yearly/*.sql
   ```

### ë°±ì—… íŒŒì¼ ì†ìƒ í™•ì¸

```bash
# SQL íŒŒì¼ ìœ íš¨ì„± ê²€ì‚¬
psql -U username -d postgres -f backup/daily/backup-daily-2025-12-15-00-00-00.sql --dry-run
```

## ê´€ë ¨ íŒŒì¼

- `src/context/backup-context/backup-scheduler.service.ts` - ë°±ì—… ìŠ¤ì¼€ì¤„ëŸ¬ (KST ê¸°ì¤€, Vercel ë¹„í™œì„±í™”)
- `src/context/backup-context/backup-context.module.ts` - ë°±ì—… ëª¨ë“ˆ
- `src/interface/backup/backup.controller.ts` - API ì»¨íŠ¸ë¡¤ëŸ¬
- `scripts/backup/backup-pure.ts` - ë°±ì—… ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸
- `scripts/backup/restore-pure.ts` - ë³µêµ¬ ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸

## ì°¸ê³ 

- BACKUP.md - ì „ì²´ ë°±ì—… ì „ëµ ë¬¸ì„œ
- README.md - ìˆ˜ë™ ë°±ì—…/ë³µêµ¬ ê°€ì´ë“œ

