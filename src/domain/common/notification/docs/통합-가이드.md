# Notification 서비스 통합 가이드

## 설치 완료 확인

다음 파일들이 정상적으로 생성되었는지 확인하세요:

```
src/domain/common/notification/
├── docs/
│   ├── notification-사용법.md
│   ├── 환경변수-설정.md
│   └── 통합-가이드.md
├── interfaces/
│   ├── index.ts
│   ├── notification-client.interface.ts
│   ├── notification.interface.ts
│   └── notification-service.interface.ts
├── notification.service.impl.ts
├── notification.service.mock.ts
├── notification.service.factory.ts
├── notification.module.ts
├── index.ts
└── README.md
```

## 통합 단계

### 1단계: 환경 변수 설정

`.env` 파일에 다음 내용을 추가하세요:

```env
# ============================================
# 알림 서비스 (Notification Service) 설정
# ============================================

# 메일 서버 URL (필수)
MAIL_SERVER_URL=http://localhost:3001

# Mock 서비스 사용 여부 (선택사항, 개발 환경에서는 true 권장)
NOTIFICATION_USE_MOCK=true
```

### 2단계: App 모듈에 통합

`src/app.module.ts` 또는 필요한 모듈에서 `NotificationModule`을 임포트하세요:

```typescript
import { Module } from '@nestjs/common';
import { NotificationModule } from '@domain/common/notification';

@Module({
  imports: [
    // ... 기존 모듈들
    NotificationModule,
  ],
})
export class AppModule {}
```

### 3단계: 서비스 사용

사용하려는 서비스 또는 컨트롤러에서 주입하세요:

```typescript
import { Injectable, Inject } from '@nestjs/common';
import { 
  INotificationService, 
  NotificationService 
} from '@domain/common/notification';

@Injectable()
export class YourService {
  constructor(
    @Inject(NotificationService)
    private readonly notificationService: INotificationService,
  ) {}

  // 알림 전송 예시
  async sendNotification() {
    const result = await this.notificationService.알림을전송한다({
      sender: 'system',
      title: '새로운 알림',
      content: '알림 내용입니다.',
      recipients: [
        {
          employeeNumber: 'emp001',
          tokens: ['fcm-token-1', 'fcm-token-2'],
        },
      ],
      sourceSystem: 'ems',
      linkUrl: '/evaluations/123',
      metadata: {
        type: 'evaluation',
        priority: 'high',
      },
    });

    if (result.success) {
      console.log('알림 전송 성공:', result.notificationId);
    } else {
      console.error('알림 전송 실패:', result.error);
    }
  }
}
```

### 4단계: 애플리케이션 실행 및 테스트

애플리케이션을 실행하고 로그를 확인하세요:

```bash
npm run start:dev
```

다음과 같은 로그가 출력되면 정상적으로 초기화된 것입니다:

**Mock 서비스 사용 시:**
```
[NotificationServiceFactory] Mock 알림 서비스를 사용합니다
[MockNotificationService] Mock 알림 서비스 초기화 완료
```

**실제 서비스 사용 시:**
```
[NotificationServiceFactory] 실제 알림 서비스를 사용합니다 (메일 서버 연동)
[NotificationServiceImpl] 알림 서비스 클라이언트 초기화 중... baseUrl: http://localhost:3001, timeoutMs: 30000
[NotificationServiceImpl] 알림 서비스 초기화 완료 (소요 시간: 123ms)
```

## 실제 사용 예시

### 예시 1: 평가 시작 알림

```typescript
async notifyEvaluationStart(employeeNumbers: string[]) {
  // SSO 서비스에서 FCM 토큰 조회
  const fcmTokens = await this.ssoService.여러직원의FCM토큰을조회한다({
    employeeNumbers,
  });

  // 수신자 목록 생성
  const recipients = fcmTokens.byEmployee.map(emp => ({
    employeeNumber: emp.employeeNumber,
    tokens: emp.tokens.map(t => t.fcmToken),
  }));

  // 알림 전송
  const result = await this.notificationService.알림을전송한다({
    sender: 'system',
    title: '평가 기간 시작',
    content: '자기평가 기간이 시작되었습니다. 평가를 진행해주세요.',
    recipients,
    sourceSystem: 'ems',
    linkUrl: '/evaluations/self',
    metadata: {
      type: 'evaluation',
      priority: 'high',
      category: 'self-evaluation',
    },
  });

  return result;
}
```

### 예시 2: 사용자 알림 목록 조회

```typescript
async getUserNotifications(employeeNumber: string, page: number = 1, pageSize: number = 20) {
  const skip = (page - 1) * pageSize;

  const result = await this.notificationService.알림목록을조회한다({
    recipientId: employeeNumber,
    skip,
    take: pageSize,
  });

  return {
    notifications: result.notifications,
    pagination: {
      page,
      pageSize,
      total: result.total,
      totalPages: Math.ceil(result.total / pageSize),
    },
    unreadCount: result.unreadCount,
  };
}
```

### 예시 3: 알림 읽음 처리

```typescript
async markNotificationAsRead(notificationId: string) {
  const result = await this.notificationService.알림을읽음처리한다({
    notificationId,
  });

  if (!result.success) {
    throw new Error('알림 읽음 처리 실패');
  }

  return result;
}
```

### 예시 4: 전체 알림 읽음 처리

```typescript
async markAllNotificationsAsRead(employeeNumber: string) {
  const result = await this.notificationService.전체알림을읽음처리한다({
    recipientId: employeeNumber,
  });

  return {
    success: result.success,
    message: result.message,
    updatedCount: result.updatedCount,
  };
}
```

## SSO 서비스와 함께 사용하기

알림 전송 시 FCM 토큰이 필요한데, 이는 SSO 서비스에서 조회할 수 있습니다:

```typescript
import { Injectable, Inject } from '@nestjs/common';
import { 
  INotificationService, 
  NotificationService 
} from '@domain/common/notification';
import { ISSOService, SSOService } from '@domain/common/sso';

@Injectable()
export class NotificationHelperService {
  constructor(
    @Inject(NotificationService)
    private readonly notificationService: INotificationService,
    @Inject(SSOService)
    private readonly ssoService: ISSOService,
  ) {}

  async sendNotificationToEmployees(
    employeeNumbers: string[],
    title: string,
    content: string,
    linkUrl?: string,
  ) {
    // 1. FCM 토큰 조회
    const fcmTokens = await this.ssoService.여러직원의FCM토큰을조회한다({
      employeeNumbers,
    });

    // 2. 수신자 목록 생성
    const recipients = fcmTokens.byEmployee
      .filter(emp => emp.tokens.length > 0) // 토큰이 있는 직원만
      .map(emp => ({
        employeeNumber: emp.employeeNumber,
        tokens: emp.tokens.map(t => t.fcmToken),
      }));

    // 3. 알림 전송
    if (recipients.length > 0) {
      return await this.notificationService.알림을전송한다({
        sender: 'system',
        title,
        content,
        recipients,
        sourceSystem: 'ems',
        linkUrl,
      });
    }

    return {
      success: false,
      message: 'FCM 토큰이 있는 수신자가 없습니다.',
    };
  }
}
```

## 주의사항

1. **환경 변수**: `MAIL_SERVER_URL`은 필수입니다 (Mock 서비스 제외)
2. **FCM 토큰**: 알림 전송 시 수신자의 FCM 토큰이 필요합니다
3. **에러 처리**: 모든 메서드는 예외를 던지지 않고 결과 객체에 에러 정보를 포함합니다
4. **페이지네이션**: 대량의 알림 조회 시 반드시 페이지네이션을 사용하세요
5. **로깅**: 모든 주요 작업은 자동으로 로깅됩니다

## 트러블슈팅

### 문제: 알림 서비스 초기화 실패

**원인**: `MAIL_SERVER_URL`이 설정되지 않았거나, 메일 서버에 접근할 수 없음

**해결방법**:
1. `.env` 파일에 `MAIL_SERVER_URL` 확인
2. 개발 환경에서는 `NOTIFICATION_USE_MOCK=true` 설정
3. 메일 서버가 실행 중인지 확인

### 문제: FCM 토큰이 없음

**원인**: 모바일 앱에서 FCM 토큰을 등록하지 않음

**해결방법**:
1. 모바일 앱에서 로그인 시 FCM 토큰 구독 확인
2. SSO 서비스의 `FCM토큰을구독한다()` 메서드 사용
3. FCM 토큰이 없는 사용자는 recipients에서 제외

### 문제: 알림이 전송되지 않음

**원인**: 메일 서버 오류 또는 네트워크 문제

**해결방법**:
1. 로그 확인 (에러 메시지 확인)
2. 메일 서버 상태 확인
3. 네트워크 연결 확인
4. 타임아웃 설정 조정 (`NOTIFICATION_TIMEOUT_MS`)

## 다음 단계

1. ✅ 환경 변수 설정 완료
2. ✅ 모듈 통합 완료
3. ✅ 서비스 사용 테스트
4. ✅ 실제 업무 로직에 통합
5. ✅ 에러 처리 및 로깅 확인

더 자세한 내용은 다음 문서를 참고하세요:
- [사용법 가이드](./notification-사용법.md)
- [환경 변수 설정](./환경변수-설정.md)
- [README](../README.md)




